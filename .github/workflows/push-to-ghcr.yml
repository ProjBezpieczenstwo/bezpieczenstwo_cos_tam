name: Build & Push Docker Image to GHCR

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Log in to GHCR
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Set up Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose

    - name: Build Docker images using Docker Compose
      run: |
        docker-compose -f docker-compose.yml build

    - name: Tag Docker images for GHCR
      run: |
        # Pobierz nazwÄ™ repozytorium GitHub
        REPO_NAME=$(basename $GITHUB_REPOSITORY)
        
        # Taguj obrazy
        docker tag ${REPO_NAME}_web:latest ghcr.io/projbezpieczenstwo/${REPO_NAME}:latest
        docker tag ${REPO_NAME}_web:latest ghcr.io/projbezpieczenstwo/${REPO_NAME}:${GITHUB_SHA}

    - name: Push Docker images to GHCR
      run: |
        docker push ghcr.io/projbezpieczenstwo/${REPO_NAME}:latest
        docker push ghcr.io/projbezpieczenstwo/${REPO_NAME}:${GITHUB_SHA}
